<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Firebase & GeoJSON</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map { width: 100%; height: 90vh; }
        #info { padding: 10px; background: white; }
        #controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }
        #controls button {
            display: block;
            margin: 5px 0;
            padding: 5px 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        #controls button.active {
            background: #28a745;
        }
    </style>
</head>
<body>

    <div id="map"></div>
    <div id="info">ƒêang t·∫£i d·ªØ li·ªáu...</div>
    <div id="controls">
        <button id="toggleOSM">B·∫≠t/T·∫Øt OSM</button>
        <button id="toggleGeoJSON">B·∫≠t/T·∫Øt B·∫£n ƒë·ªì</button>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js';
        import { getFirestore, collection, getDocs } from 'https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore.js';

        // C·∫•u h√¨nh Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAQO2BmNaZcast3fRMTUUo7FzvuupdTE0w",
            authDomain: "compact-mystery-420806.firebaseapp.com",
            projectId: "compact-mystery-420806",
            storageBucket: "compact-mystery-420806.appspot.com",
            messagingSenderId: "1072971256470",
            appId: "1:1072971256470:web:1fd0e2d50054f48a9328b7",
            measurementId: "G-5MDD2BR4PL"
        };

        // Kh·ªüi t·∫°o Firebase
        const firebaseApp = initializeApp(firebaseConfig);
        const db = getFirestore(firebaseApp);
        const treesRef = collection(db, 'trees');

        // T·∫°o b·∫£n ƒë·ªì Leaflet
        const map = L.map('map').setView([21.0285, 105.8542], 10);

        // T·∫°o l·ªõp OSM
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        });

        // T·∫°o l·ªõp GeoJSON
        let geojsonLayer = null;

        // Th√™m l·ªõp OSM m·∫∑c ƒë·ªãnh
        osmLayer.addTo(map);

        let bounds = L.latLngBounds();

        // T·∫£i d·ªØ li·ªáu t·ª´ Firestore v√† hi·ªÉn th·ªã marker c√¢y xanh
        async function loadTreeData() {
            try {
                const querySnapshot = await getDocs(treesRef);
                if (querySnapshot.empty) {
                    document.getElementById('info').innerHTML = "‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu Firestore!";
                    return;
                }

                let content = "<b>D·ªØ li·ªáu c√¢y xanh:</b><br>";
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.location && typeof data.location.lat === 'number' && typeof data.location.long === 'number') {
                        const { lat, long } = data.location;

                        // Th√™m marker v√†o b·∫£n ƒë·ªì
                        const marker = L.marker([lat, long]).addTo(map)
                            .bindPopup(`
                                <b>${data.treeType || 'Kh√¥ng r√µ'}</b><br>
                                üìç <b>V·ªã tr√≠:</b> ${lat}, ${long}<br>
                                üïí <b>Th·ªùi gian:</b> ${data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleString() : 'Kh√¥ng c√≥ th√¥ng tin'}<br>
                                ${data.imageUrl ? `<img src="${data.imageUrl}" alt="Tree Image" style="width: 100px; height: 100px; object-fit: cover;">` : ''}
                            `);
                        bounds.extend([lat, long]);

                        content += `üå≥ Lo·∫°i c√¢y: ${data.treeType || 'Kh√¥ng r√µ'}, üìç ${lat}, ${long} <br>`;
                    }
                });

                // Hi·ªÉn th·ªã th√¥ng tin danh s√°ch c√¢y
                document.getElementById('info').innerHTML = content;
            } catch (error) {
                document.getElementById('info').innerHTML = `üî• L·ªói Firestore: ${error.message}`;
                console.error("L·ªói Firestore:", error);
            }
        }

        // H√†m ƒë·ªÉ hi·ªÉn th·ªã GeoJSON tr√™n b·∫£n ƒë·ªì
        function loadGeoJSON(geojsonData) {
            try {
                if (geojsonLayer) {
                    map.removeLayer(geojsonLayer); // X√≥a l·ªõp GeoJSON c≈© n·∫øu c√≥
                }
                geojsonLayer = L.geoJSON(geojsonData, {
                    style: {
                        color: "#ff7800", // M√†u cam
                        weight: 2,
                        opacity: 0.7,
                        fillColor: "#ff7800", // M√†u cam
                        fillOpacity: 0.3
                    },
                    onEachFeature: function (feature, layer) {
                        if (feature.properties && feature.properties.name) {
                            // Hi·ªÉn th·ªã th√¥ng tin khi click v√†o v√πng
                            layer.bindPopup(`
                                <b>Khu v·ª±c:</b> ${feature.properties.name}<br>
                                <b>Di·ªán t√≠ch:</b> ${feature.properties.area_km2.toFixed(2)} km¬≤
                            `);
                        }
                        layer.on('mouseover', function () {
                            this.setStyle({ fillOpacity: 0.6 });
                        });
                        layer.on('mouseout', function () {
                            this.setStyle({ fillOpacity: 0.3 });
                        });

                        // M·ªü r·ªông ph·∫°m vi hi·ªÉn th·ªã b·∫£n ƒë·ªì ƒë·ªÉ bao g·ªìm c·∫£ v√πng
                        if (layer.getBounds) {
                            bounds.extend(layer.getBounds());
                        }
                    }
                });
                if (document.getElementById('toggleGeoJSON').classList.contains('active')) {
                    geojsonLayer.addTo(map); // Th√™m l·ªõp GeoJSON n·∫øu ƒëang b·∫≠t
                }
                if (bounds.isValid()) {
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            } catch (error) {
                console.error("L·ªói khi t·∫£i GeoJSON:", error);
            }
        }

        // G·ªçi h√†m ƒë·ªÉ t·∫£i d·ªØ li·ªáu
        loadTreeData();
        window.receiveGeoJSON = function(geojsonData) {
            loadGeoJSON(geojsonData);
        };

        // ƒêi·ªÅu khi·ªÉn t·∫Øt/b·∫≠t l·ªõp OSM
        document.getElementById('toggleOSM').addEventListener('click', function () {
            if (map.hasLayer(osmLayer)) {
                map.removeLayer(osmLayer);
                this.classList.remove('active');
            } else {
                osmLayer.addTo(map);
                this.classList.add('active');
            }
        });

        // ƒêi·ªÅu khi·ªÉn t·∫Øt/b·∫≠t l·ªõp GeoJSON
        document.getElementById('toggleGeoJSON').addEventListener('click', function () {
            if (geojsonLayer) {
                if (map.hasLayer(geojsonLayer)) {
                    map.removeLayer(geojsonLayer);
                    this.classList.remove('active');
                } else {
                    geojsonLayer.addTo(map);
                    this.classList.add('active');
                }
            }
        });
    </script>
</body>
</html>